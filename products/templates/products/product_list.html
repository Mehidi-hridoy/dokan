{% extends 'base.html' %}
{% load static %}
{% load product_filters %}
{% load product_extras %}

{% load humanize %}

{% block title %}{{ header_name }} - Dokan{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .discount-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ef4444;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }
    .filter-active {
        background-color: #3b82f6 !important;
        color: white !important;
    }
    .sort-active {
        background-color: #e5e7eb;
        font-weight: 600;
    }
    .review-btn {
        background-color: #10b981;
        color: white;
    }
    .review-btn:hover {
        background-color: #059669;
    }
    .filter-section {
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .filter-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .filter-link {
        display: flex;
        justify-content: space-between; /* Adjusted 'between' to 'space-between' */
        align-items: center;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
        text-decoration: none;
    }
    .filter-link:hover {
        background-color: #f3f4f6;
    }
    .count-badge {
        background-color: #6b7280;
        color: white;
        padding: 0.125rem 0.5rem;
        border-radius: 0.75rem;
        font-size: 0.75rem;
        margin-left: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2 text-sm">
                <li><a href="{% url 'products:home' %}" class="text-blue-600 hover:text-blue-800">Home</a></li>
                <li class="flex items-center">
                    <span class="text-gray-400 mx-2">/</span>
                    <span class="text-gray-600">Products</span>
                </li>
                {% comment %} The header is dynamic, so we only show the current filter name in the breadcrumb if one is active {% endcomment %}
                {% if selected_category or selected_brand or search_query %} 
                <li class="flex items-center">
                    <span class="text-gray-400 mx-2">/</span>
                    <span class="text-gray-900 font-medium">{{ header_name }}</span>
                </li>
                {% endif %}
            </ol>
        </nav>
        
        <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ header_name }}</h1>
        <p class="text-gray-600">Found {{ page_obj.paginator.count|default:"0" }} product{{ page_obj.paginator.count|default:"0"|pluralize }}</p> 
        {% comment %} Use page_obj.paginator.count for total count, not just current page length {% endcomment %}
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <div class="lg:w-1/4">
            <div class="bg-white rounded-lg shadow-sm border p-6 sticky top-24">
                
                {% comment %} 
                *** IMPORTANT: The variables 'categories', 'category_counts', 'brands', and 'brand_counts' are missing from your ProductListView. You MUST add them to get_context_data for the sidebar to work. *** {% endcomment %}

                <div class="filter-section">
                    <h3 class="font-semibold text-lg mb-4 text-gray-900">Price Range</h3>
                    <form method="GET" action="{% url 'products:product_list' %}" class="space-y-3">
                        {% comment %} Hidden inputs to maintain existing filters when only price is changed {% endcomment %}
                        {% if search_query %}<input type="hidden" name="search" value="{{ search_query }}">{% endif %}
                        {% if selected_category %}<input type="hidden" name="category" value="{{ selected_category }}">{% endif %}
                        {% if selected_brand %}<input type="hidden" name="brand" value="{{ selected_brand }}">{% endif %}
                        {% if current_sort and current_sort != 'name_asc' %}<input type="hidden" name="sort" value="{{ current_sort }}">{% endif %}
                        
                        <div class="flex space-x-3">
                            <input type="number" name="min_price" placeholder="Min $" 
                                   value="{{ request.GET.min_price }}"
                                   class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500">
                            <input type="number" name="max_price" placeholder="Max $" 
                                   value="{{ request.GET.max_price }}"
                                   class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                            Apply Price Filter
                        </button>
                    </form>
                </div>

                {% if categories %}
                <div class="filter-section">
                    <h3 class="font-semibold text-lg mb-4 text-gray-900">Categories</h3>
                    <div class="space-y-1">

{% with current_query=request.GET.urlencode|remove_query_param:"page" %}
    <a href="?{{ current_query }}&page={{ page_number }}">Page {{ page_number }}</a>
{% endwith %}


                       
                        
                        {% for category in categories %}
                        {% with base_url=request.GET.urlencode|remove_query_param:"category" query_sep="&" %}
                        <a href="?{{ base_url }}{{ query_sep }}category={{ category.slug }}" 
                           class="filter-link {% if selected_category == category.slug %}filter-active{% else %}text-gray-700{% endif %}">
                            {{ category.name }}
                            <span class="count-badge">
                                {{ category_counts|get_item:category.id|default:"0" }}
                            </span>
                        </a>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if brands %}
                <div class="filter-section">
                    <h3 class="font-semibold text-lg mb-4 text-gray-900">Brands</h3>
                    <div class="space-y-1">
                        {% with full_url=request.GET.urlencode|remove_query_param:"brand" %}
                        <a href="?{{ full_url }}" 
                           class="filter-link {% if not selected_brand %}filter-active{% else %}text-gray-700{% endif %}">
                            All Brands
                            <span class="count-badge">
                                {{ brands|length }}
                            </span>
                        </a>
                        {% endwith %}
                        
                        {% for brand in brands %}
                        {% with base_url=request.GET.urlencode|remove_query_param:"brand" query_sep="&" %}
                        <a href="?{{ base_url }}{{ query_sep }}brand={{ brand.slug }}" 
                           class="filter-link {% if selected_brand == brand.slug %}filter-active{% else %}text-gray-700{% endif %}">
                            {{ brand.name }}
                            <span class="count-badge">
                                {{ brand_counts|get_item:brand.id|default:"0" }}
                            </span>
                        </a>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if selected_category or selected_brand or request.GET.min_price or request.GET.max_price or search_query %}
                <div class="filter-section">
                    <h3 class="font-semibold text-lg mb-3 text-gray-900">Active Filters</h3>
                    <div class="flex flex-wrap gap-2">
                        
                        {% if search_query %}
                        {% with full_url=request.GET.urlencode|remove_query_param:"search" %}
                        <a href="?{{ full_url }}" 
                           class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm flex items-center hover:bg-blue-200">
                            Search: {{ search_query|truncatechars:15 }}
                            <i class="fas fa-times ml-1"></i>
                        </a>
                        {% endwith %}
                        {% endif %}

                        {% if selected_category %}
                        {% with full_url=request.GET.urlencode|remove_query_param:"category" %}
                        <a href="?{{ full_url }}" 
                           class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm flex items-center hover:bg-blue-200">
                            Category: {{ selected_category }} 
                            <i class="fas fa-times ml-1"></i>
                        </a>
                        {% endwith %}
                        {% endif %}
                        
                        {% if selected_brand %}
                        {% with full_url=request.GET.urlencode|remove_query_param:"brand" %}
                        <a href="?{{ full_url }}" 
                           class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm flex items-center hover:bg-blue-200">
                            Brand: {{ selected_brand }}
                            <i class="fas fa-times ml-1"></i>
                        </a>
                        {% endwith %}
                        {% endif %}

                        {% if request.GET.min_price or request.GET.max_price %}
                        {% with url_min=request.GET.urlencode|remove_query_param:"min_price" url_max=url_min|remove_query_param:"max_price" %}
                        <a href="?{{ url_max }}" 
                           class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm flex items-center hover:bg-blue-200">
                            Price: 
                            ${{ request.GET.min_price|default:"0" }} - ${{ request.GET.max_price|default:"âˆž" }}
                            <i class="fas fa-times ml-1"></i>
                        </a>
                        {% endwith %}
                        {% endif %}

                    </div>
                    <a href="{% url 'products:product_list' %}" class="text-red-600 text-sm mt-2 inline-block hover:text-red-700">
                        Clear all filters
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="lg:w-3/4">
            <div class="bg-white rounded-lg shadow-sm border p-4 mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-700 font-medium">Sort by:</span>
                        <div class="flex flex-wrap gap-2">
                            {% with base_url=request.GET.urlencode|remove_query_param:"sort" query_sep="&" %}
                            
                            <a href="?{{ base_url }}{{ query_sep }}sort=name_asc" 
                               class="px-3 py-1 rounded text-sm {% if current_sort == 'name_asc' %}sort-active{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
                                Name (A-Z)
                            </a>
                            <a href="?{{ base_url }}{{ query_sep }}sort=price_asc" 
                               class="px-3 py-1 rounded text-sm {% if current_sort == 'price_asc' %}sort-active{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
                                Price: Low to High
                            </a>
                            <a href="?{{ base_url }}{{ query_sep }}sort=price_desc" 
                               class="px-3 py-1 rounded text-sm {% if current_sort == 'price_desc' %}sort-active{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
                                Price: High to Low
                            </a>
                            <a href="?{{ base_url }}{{ query_sep }}sort=rating_desc" 
                               class="px-3 py-1 rounded text-sm {% if current_sort == 'rating_desc' %}sort-active{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
                                Top Rated
                            </a>
                            <a href="?{{ base_url }}{{ query_sep }}sort=newest" 
                               class="px-3 py-1 rounded text-sm {% if current_sort == 'newest' %}sort-active{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
                                Newest
                            </a>
                            {% endwith %}
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} results
                    </div>
                </div>
            </div>

            {% if products %}

<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for product in products %}
    <div class="product-card bg-white rounded-lg shadow-md overflow-hidden border border-gray-100">
        <div class="relative overflow-hidden">
            <img src="{{ product.thumbnail }}" alt="{{ product.products_name }}" 
                 class="w-full h-48 object-cover transition duration-300 hover:scale-105">
        
            {% if product|discount_percentage %}
                <div class="discount-badge absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded text-xs">
                    -{{ product|discount_percentage }}%
                </div>
            {% endif %}

            <div class="absolute top-2 left-2">
                {% if not product.is_out_of_stock %}
                    <span class="bg-green-500 text-white px-2 py-1 rounded text-xs">In Stock ({{ product.stock_available }})</span>
                {% else %}
                    <span class="bg-red-500 text-white px-2 py-1 rounded text-xs">Out of Stock</span>
                {% endif %}
            </div>
        </div>
        
        <div class="p-4">
            <div class="flex justify-between items-start mb-2">
                <h3 class="font-semibold text-gray-800 truncate flex-1 mr-2" title="{{ product.products_name }}">
                    <a href="{% url 'products:product_detail' product.slug %}" class="hover:text-blue-600">
                        {{ product.products_name }}
                    </a>
                </h3>
                {% if product.category %}
                    <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">{{ product.category.name }}</span>
                {% endif %}
            </div>
            
            {% if product.brand %}
                <p class="text-gray-500 text-sm mb-2">by {{ product.brand.name }}</p>
            {% endif %}
            
            <p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ product.description|striptags|truncatewords:15 }}</p>
            
            {% if product.tag_list %}
            <div class="mb-4 flex flex-wrap gap-2">
                {% for tag in product.tag_list %}
                    <a href="{% url 'products:product_list' %}?tag={{ tag|urlencode }}" class="inline-block text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full hover:bg-blue-600 hover:text-white transition">
                        {{ tag }}
                    </a>
                {% endfor %}
            </div>
            {% endif %}

            <div class="flex items-center justify-between mb-3">
<div class="flex items-baseline space-x-2">
    <!-- Current Price -->
    <span class="text-2xl font-bold text-green-600">${{ product.current_price|floatformat:2|intcomma }}</span>

    <!-- Base Price (strikethrough if discounted) -->
    {% if product.sale_price and product.sale_price < product.base_price %}
        <span class="text-lg text-gray-400 line-through">${{ product.base_price|floatformat:2|intcomma }}</span>
    {% endif %}
</div>

                
                {% if product.avg_rating %}
                <div class="flex items-center text-yellow-400">
                    <i class="fas fa-star"></i>
                    <span class="text-gray-600 text-sm ml-1">{{ product.avg_rating|floatformat:1 }}/5</span>
                </div>
                {% endif %}
            </div>
            
            <div class="space-y-2">
                <div class="flex space-x-2">
                    <a href="{% url 'products:product_detail' product.slug %}" 
                       class="flex-1 bg-gray-100 text-gray-700 text-center py-2 rounded hover:bg-gray-200 transition duration-200 text-sm">
                        View Details
                    </a>
                    
                    {% if not product.is_out_of_stock %}
                    <form action="{% url 'orders:add_to_cart' product.slug %}" method="POST" class="flex-1">
                        {% csrf_token %}
                        <button type="submit" 
                                class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition duration-200 text-sm">
                            Add to Cart
                        </button>
                    </form>
                    {% else %}
                    <button class="w-full bg-gray-400 text-white py-2 rounded text-sm cursor-not-allowed" disabled>
                        Out of Stock
                    </button>
                    {% endif %}
                </div>
                
                {% if product.can_review %}
                <button onclick="openReviewModal('{{ product.slug }}', '{{ product.products_name }}')" 
                        class="w-full review-btn py-2 rounded transition duration-200 text-sm flex items-center justify-center">
                    <i class="fas fa-star mr-2"></i>
                    Add Review
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

            {% if is_paginated %}
                <div class="flex justify-center mt-8">
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if page_obj.has_previous %}
                            <a href="?{{ request.GET.urlencode|remove_query_param:'page' }}&page={{ page_obj.previous_page_number }}" 
                               class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Previous</span>
                                <i class="fas fa-chevron-left h-5 w-5"></i>
                            </a>
                        {% endif %}

                        {% for i in paginator.page_range %}
                            {% if page_obj.number == i %}
                                <span aria-current="page" 
                                      class="relative inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 text-sm font-medium text-blue-600">
                                    {{ i }}
                                </span>
                            {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' or i == 1 or i == paginator.num_pages %}
                                <a href="?{{ request.GET.urlencode|remove_query_param:'page' }}&page={{ i }}" 
                                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    {{ i }}
                                </a>
                            {% elif i == page_obj.number|add:'-3' or i == page_obj.number|add:'3' %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                    ...
                                </span>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <a href="?{{ request.GET.urlencode|remove_query_param:'page' }}&page={{ page_obj.next_page_number }}" 
                               class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Next</span>
                                <i class="fas fa-chevron-right h-5 w-5"></i>
                            </a>
                        {% endif %}
                    </nav>
                </div>
            {% endif %}

            {% else %}
            <div class="text-center py-16 bg-white rounded-lg shadow-sm border">
                <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No products found</h3>
                <p class="text-gray-500 mb-6">Try adjusting your filters or search terms.</p>
                <a href="{% url 'products:product_list' %}" 
                   class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                    Browse All Products
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>Brands

<div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold" id="reviewProductName">Add Review</h3>
            <button onclick="closeReviewModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="reviewForm" method="POST" action="#"> 
            {% comment %} Assuming you have an 'add_review' URL name {% endcomment %}
            {% csrf_token %}
            <input type="hidden" id="reviewProductSlug" name="product_slug">
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
                <div class="flex space-x-1" id="ratingStars">
                    {% for i in "12345" %}
                    <button type="button" class="text-2xl text-gray-300 hover:text-yellow-400" 
                            data-rating="{{ i }}" onclick="setRating({{ i }})">
                        <i class="fas fa-star"></i>
                    </button>
                    {% endfor %}
                </div>
                <input type="hidden" id="ratingValue" name="rating" required>
            </div>
            
            <div class="mb-4">
                <label for="reviewTitle" class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                <input type="text" id="reviewTitle" name="title" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Brief summary of your review">
            </div>
            
            <div class="mb-4">
                <label for="reviewComment" class="block text-sm font-medium text-gray-700 mb-2">Review</label>
                <textarea id="reviewComment" name="comment" rows="4"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Share your experience with this product..."></textarea>
            </div>
            
            <div class="flex space-x-3">
                <button type="button" onclick="closeReviewModal()" 
                         class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                    Cancel
                </button>
                <button type="submit" 
                         class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition duration-200">
                    Submit Review
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- Review Modal Functions ---
    function openReviewModal(slug, name) {
        document.getElementById('reviewProductSlug').value = slug;
        document.getElementById('reviewProductName').textContent = `Add Review for ${name}`;
        document.getElementById('reviewModal').classList.remove('hidden');
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').classList.add('hidden');
        // Optional: Reset form fields and rating
        document.getElementById('reviewForm').reset();
        setRating(0);
    }

    function setRating(value) {
        document.getElementById('ratingValue').value = value;
        const stars = document.getElementById('ratingStars').querySelectorAll('button');
        stars.forEach(star => {
            const starValue = parseInt(star.getAttribute('data-rating'));
            if (starValue <= value) {
                star.querySelector('i').classList.add('text-yellow-400');
                star.querySelector('i').classList.remove('text-gray-300');
            } else {
                star.querySelector('i').classList.remove('text-yellow-400');
                star.querySelector('i').classList.add('text-gray-300');
            }
        });
    }

    // Optional: Close modal when clicking outside
    document.getElementById('reviewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReviewModal();
        }
    });

    // --- Add to Cart (AJAX/Functional) ---
    document.addEventListener('DOMContentLoaded', function() {
        // Keep your original AJAX logic for Add to Cart
        const addToCartForms = document.querySelectorAll('form[action*="add_to_cart"]');
        
        addToCartForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const url = this.action;
                
                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => { throw new Error(data.message || 'Server error'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showMessage(data.message, 'success');
                        // Assuming you have a function to update the cart icon count in your base.html
                        updateCartCount(data.cart_count); 
                    } else {
                        showMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage(`An error occurred: ${error.message || 'Please try again.'}`, 'error');
                });
            });
        });
    });
    
    // Placeholder functions (You'd implement real Toast/Notification logic)
    function showMessage(message, type) {
        // Replace this with your preferred notification system (e.g., Toastify, Django messages)
        alert(`${type.toUpperCase()}: ${message}`); 
    }
    
    function updateCartCount(count) {
        // Update the cart count badge in your header/base.html
        const cartCountElement = document.querySelector('#cart-count-badge'); 
        if (cartCountElement) {
            cartCountElement.textContent = count;
        }
    }
</script>
<script src="{% static 'js/global.js' %}"></script>
{% endblock %}