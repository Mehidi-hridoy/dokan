{% extends 'base.html' %}
{% load static %}

{% block title %}Home - Dokan{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'products/css/home.css' %}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <nav class="text-sm breadcrumbs mb-6">
        <a href="{% url 'products:home' %}" class="text-blue-600">Home</a>
    </nav>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <aside class="md:col-span-1">
            <h2 class="text-xl font-semibold mb-4">Categories</h2>
            <ul class="space-y-2">
                {% for category in categories %}
                    <li><a href="#" class="text-gray-700 hover:text-blue-600">{{ category.name }}</a></li>
                {% empty %}
                    <li>No categories</li>
                {% endfor %}
            </ul>
            <h2 class="text-xl font-semibold mb-4 mt-6">Brands</h2>
            <ul class="space-y-2">
                {% for brand in brands %}
                    <li><a href="#" class="text-gray-700 hover:text-blue-600">{{ brand.name }}</a></li>
                {% empty %}
                    <li>No brands</li>
                {% endfor %}
            </ul>
        </aside>

        <section class="md:col-span-3">
            <h1 class="text-3xl font-bold mb-6">Featured Products</h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for product in products %}
                    <div class="bg-white shadow-md rounded-lg overflow-hidden hover:shadow-xl transition duration-300">
                        {% if product.products_image %}
                            <img src="{{ product.products_image.url }}" alt="{{ product.products_name }}" class="w-full h-48 object-cover">
                        {% endif %}
                        <div class="p-4">
                            <h3 class="text-lg font-semibold mb-2"><a href="{% url 'products:product_detail' product.slug %}">{{ product.products_name }}</a></h3>
                            
                            <p class="text-gray-800 font-bold mb-1">${{ product.current_price }}</p> 
                            
                            {# --- Stock Display Added Here --- #}
                            {% if product.is_in_stock %}
                                <p class="text-sm {% if product.is_low_stock %}text-red-500 font-medium{% else %}text-green-600{% endif %} mb-2 flex items-center">
                                    <i class="fas fa-box-open mr-1"></i>
                                    In Stock ({{ product.available_quantity }} left)
                                </p>
                            {% else %}
                                <p class="text-sm text-red-700 font-medium mb-2 flex items-center">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    Out of Stock
                                </p>
                            {% endif %}
                            {# --------------------------------- #}
                            
                            <p class="text-sm text-gray-500 mb-4">{{ product.short_description|truncatewords:20 }}</p>
                            
                            <form class="add-to-cart-form" action="{% url 'orders:add_to_cart' product.slug %}" method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="quantity" value="1">
                                
                                {% if product.is_in_stock %}
                                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full transition duration-200">
                                        Add to Cart
                                    </button>
                                {% else %}
                                    <button type="button" disabled class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed w-full">
                                        Out of Stock
                                    </button>
                                {% endif %}
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p>No products available.</p>
                {% endfor %}
            </div>
        </section>
    </div>
</div>

<script>
$(document).ready(function() {
    // 1. Target all forms with the class 'add-to-cart-form'
    $('.add-to-cart-form').on('submit', function(e) {
        e.preventDefault(); // Prevent the default form submission (browser refresh)
        
        const form = $(this);
        const url = form.attr('action');
        const method = form.attr('method');
        const data = form.serialize(); // Serialize form data (including CSRF token and quantity)

        // Disable button while processing
        const submitButton = form.find('button[type="submit"]');
        submitButton.prop('disabled', true).text('Adding...');

        $.ajax({
            url: url,
            method: method,
            data: data,
            dataType: 'json', // Expecting JSON response
            success: function(response) {
                if (response.success) {
                    // 2. Update the cart count in the navbar
                    $('#cart-count-badge').text(response.cart_count);
                    
                    // Re-enable button and change text
                    submitButton.prop('disabled', false).text('Added!'); 
                    setTimeout(() => submitButton.text('Add to Cart'), 2000); // Revert text after 2s
                    
                    // You should also display response.message (e.g., as a toast notification)
                    console.log(response.message);
                    
                } else {
                    alert('Error: ' + response.message);
                    submitButton.prop('disabled', false).text('Add to Cart'); // Re-enable button on error
                }
            },
            error: function(xhr, status, error) {
                // Handle non-200 responses (like the out-of-stock 400 status)
                let errorMessage = "An unknown error occurred.";
                try {
                    const responseJson = JSON.parse(xhr.responseText);
                    errorMessage = responseJson.message || errorMessage;
                } catch (e) {
                    // pass
                }
                alert('Failed to add to cart: ' + errorMessage);
                submitButton.prop('disabled', false).text('Add to Cart'); // Re-enable button on error
            }
        });
    });
});
</script>
{% endblock %}