{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Home - Dokan{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'products/css/home.css' %}">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <nav class="text-sm breadcrumbs mb-6">
        <a href="{% url 'products:home' %}" class="text-blue-600">Home</a>
    </nav>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <!-- Sidebar -->
        <aside class="md:col-span-1">
            <h2 class="text-xl font-semibold mb-4">Categories</h2>
            <ul class="space-y-2">
                {% for category in categories %}
                    <li><a href="#" class="text-gray-700 hover:text-blue-600">{{ category.name }}</a></li>
                {% empty %}
                    <li>No categories</li>
                {% endfor %}
            </ul>

            <h2 class="text-xl font-semibold mb-4 mt-6">Brands</h2>
            <ul class="space-y-2">
                {% for brand in brands %}
                    <li><a href="#" class="text-gray-700 hover:text-blue-600">{{ brand.name }}</a></li>
                {% empty %}
                    <li>No brands</li>
                {% endfor %}
            </ul>
        </aside>

        <!-- Main Product Grid -->
        <section class="md:col-span-3">
            <h1 class="text-3xl font-bold mb-6">Featured Products</h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for product in products %}
                    <div class="bg-white shadow-md rounded-lg overflow-hidden hover:shadow-xl transition duration-300">
                        {% if product.products_image %}
                            <img src="{{ product.products_image.url }}" alt="{{ product.products_name }}" class="w-full h-48 object-cover">
                        {% endif %}

                        <div class="p-4">
                            <h3 class="text-lg font-semibold mb-2">
                                <a href="{% url 'products:product_detail' product.slug %}">{{ product.products_name }}</a>
                            </h3>

                            <!-- Price & Discount -->
                            <p class="text-2xl text-green-600 mb-4 flex items-center space-x-2">
                                <span>${{ product.current_price_display|intcomma }}</span>
                                {% if product.discount_percentage %}
                                    <span class="line-through text-gray-500">${{ product.base_price|intcomma }}</span>
                                    <span class="discount-badge bg-red-500 text-white px-2 py-1 rounded text-sm">
                                        -{{ product.discount_percentage }}%
                                    </span>
                                {% endif %}
                            </p>

                            <!-- Stock Status -->
                            {% if product.is_in_stock %}
                                <p class="text-sm {% if product.is_low_stock %}text-red-500 font-medium{% else %}text-green-600{% endif %} mb-2 flex items-center">
                                    <i class="fas fa-box-open mr-1"></i>
                                    In Stock ({{ product.available_quantity }} left)
                                </p>
                            {% else %}
                                <p class="text-sm text-red-700 font-medium mb-2 flex items-center">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    Out of Stock
                                </p>
                            {% endif %}

{% if product.short_description|striptags %}
    <p class="text-sm text-gray-500 mb-4">{{ product.short_description|safe }}</p>
{% endif %}

                            <!-- Add to Cart -->
                            <form class="add-to-cart-form" action="{% url 'orders:add_to_cart' product.slug %}" method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="quantity" value="1">
                                {% if product.is_in_stock %}
                                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full transition duration-200">
                                        Add to Cart
                                    </button>
                                {% else %}
                                    <button type="button" disabled class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed w-full">
                                        Out of Stock
                                    </button>
                                {% endif %}
                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p>No products available.</p>
                {% endfor %}
            </div>
        </section>
    </div>
</div>

<script>
$(document).ready(function() {
    $('.add-to-cart-form').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        const submitButton = form.find('button[type="submit"]');
        const url = form.attr('action');
        const data = form.serialize();

        submitButton.prop('disabled', true).text('Adding...');

        $.ajax({
            url: url,
            method: 'POST',
            data: data,
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    $('#cart-count-badge').text(response.cart_count);
                    submitButton.text('Added!');
                    setTimeout(() => submitButton.text('Add to Cart'), 2000);
                } else {
                    alert('Error: ' + response.message);
                    submitButton.prop('disabled', false).text('Add to Cart');
                }
            },
            error: function(xhr) {
                let msg = "An unknown error occurred.";
                try {
                    const res = JSON.parse(xhr.responseText);
                    msg = res.message || msg;
                } catch {}
                alert('Failed to add to cart: ' + msg);
                submitButton.prop('disabled', false).text('Add to Cart');
            }
        });
    });
});
</script>
{% endblock %}
