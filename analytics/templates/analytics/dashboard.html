{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Analytics Dashboard</h1>
        <div class="d-none d-sm-inline-block">
            <!-- Date Range Filter -->
            <form method="GET" class="form-inline">
                <div class="input-group">
                    <select name="period" class="form-control form-control-sm" onchange="this.form.submit()">
                        <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                        <option value="yesterday" {% if period == 'yesterday' %}selected{% endif %}>Yesterday</option>
                        <option value="7d" {% if period == '7d' %}selected{% endif %}>Last 7 Days</option>
                        <option value="30d" {% if period == '30d' %}selected{% endif %}>Last 30 Days</option>
                        <option value="90d" {% if period == '90d' %}selected{% endif %}>Last 90 Days</option>
                        <option value="365d" {% if period == '365d' %}selected{% endif %}>Last Year</option>
                        <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                    </select>
                    {% if period == 'custom' %}
                    <input type="date" name="start_date" value="{{ start_date|date:'Y-m-d' }}" class="form-control form-control-sm">
                    <input type="date" name="end_date" value="{{ end_date|date:'Y-m-d' }}" class="form-control form-control-sm">
                    <button type="submit" class="btn btn-primary btn-sm">Apply</button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="row">
        <!-- Total Revenue -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Revenue</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">৳{{ kpis.total_revenue|floatformat:2 }}</div>
                            <div class="text-xs text-muted">Avg Daily: ৳{{ kpis.daily_sales|floatformat:2 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Orders -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Orders</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.total_orders }}</div>
                            <div class="text-xs text-muted">Avg Value: ৳{{ kpis.avg_order_value|floatformat:2 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shopping-cart fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Customers -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                New Customers</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.new_customers }}</div>
                            <div class="text-xs text-muted">Retention: {{ kpis.retention_rate|floatformat:1 }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-plus fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Sold -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Products Sold</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.products_sold }}</div>
                            <div class="text-xs text-muted">Conversion: {{ kpis.conversion_rate|floatformat:1 }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-box fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Overview -->
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Financial Overview</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="font-weight-bold">Revenue:</span>
                        <span class="float-right text-success">৳{{ financial_overview.total_revenue|floatformat:2 }}</span>
                    </div>
                    <div class="mb-3">
                        <span class="font-weight-bold">Expenses:</span>
                        <span class="float-right text-danger">৳{{ financial_overview.total_expenses|floatformat:2 }}</span>
                    </div>
                    <div class="mb-3">
                        <span class="font-weight-bold">Net Profit:</span>
                        <span class="float-right {% if financial_overview.net_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ৳{{ financial_overview.net_profit|floatformat:2 }}
                        </span>
                    </div>
                    <div class="mb-3">
                        <span class="font-weight-bold">Profit Margin:</span>
                        <span class="float-right {% if financial_overview.profit_margin >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ financial_overview.profit_margin|floatformat:1 }}%
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Statistics -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Customer Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="font-weight-bold">Total Customers:</span>
                        <span class="float-right">{{ customer_stats.total_customers }}</span>
                    </div>
                    <div class="mb-3">
                        <span class="font-weight-bold">New Customers:</span>
                        <span class="float-right text-success">{{ customer_stats.new_customers }}</span>
                    </div>
                    <div class="mb-3">
                        <span class="font-weight-bold">Repeat Rate:</span>
                        <span class="float-right text-info">{{ customer_stats.repeat_rate|floatformat:1 }}%</span>
                    </div>
                    <div class="mb-3">
                        <span class="font-weight-bold">VIP Customers:</span>
                        <span class="float-right text-warning">{{ customer_stats.segments.vip_customers }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Status -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Inventory Status</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="font-weight-bold">Total Products:</span>
                        <span class="float-right">{{ operations_analytics.inventory.total_products }}</span>
                    </div>
                    <div class="mb-3">
                        <span class="font-weight-bold text-warning">Low Stock:</span>
                        <span class="float-right">{{ operations_analytics.pending_actions.low_stock_items }}</span>
                    </div>
                    <div class="mb-3">
                        <span class="font-weight-bold text-danger">Out of Stock:</span>
                        <span class="float-right">{{ product_analytics.out_of_stock }}</span>
                    </div>
                    <div class="mb-3">
                        <span class="font-weight-bold">Active Alerts:</span>
                        <span class="float-right text-danger">{{ operations_analytics.active_alerts }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
<div class="metric-card">
    <h3>Stock Change</h3>
    
    {% if stock_change > 0 %}
        <span class="text-success">Up by </span>
    {% elif stock_change < 0 %}
        <span class="text-danger">Down by </span>
    {% else %}
        <span class="text-info">No change </span>
    {% endif %}
    
    <strong>{{ absolute_stock_change }}</strong> units.
</div>
    <!-- Charts and Detailed Analytics -->
    <div class="row">
        <!-- Sales Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Sales Trend</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="switchChart('revenue')">Revenue</button>
                        <button class="btn btn-outline-primary" onclick="switchChart('orders')">Orders</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="salesChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Activities</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% for activity in recent_activities %}
                    <div class="mb-3 pb-3 border-bottom">
                        <div class="d-flex align-items-start">
                            <div class="mr-3">
                                <i class="fas {{ activity.icon }} text-{{ activity.color }}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="small font-weight-bold">{{ activity.title }}</div>
                                <div class="small text-muted">{{ activity.description }}</div>
                                <div class="small text-muted">
<span class="{% if activity.amount >= 0 %}text-success{% else %}text-danger{% endif %}">
    {% if activity.amount >= 0 %}
        ৳{{ activity.amount|floatformat:2 }}
    {% else %}
        -৳{{ activity.absolute_amount|floatformat:2 }}
    {% endif %}
</span>

                                    • {{ activity.timestamp|timesince }} ago
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-info-circle fa-2x mb-2"></i>
                        <p>No recent activities</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Top Products and Order Status -->
    <div class="row">
        <!-- Top Products -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Top Selling Products</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Product Code</th>
                                    <th>Price</th>
                                    <th>Units Sold</th>
                                    <th>Revenue</th>
                                    <th>Orders</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in product_analytics.top_products %}
                                <tr>
                                    <td class="font-weight-bold">{{ product.product__products_name }}</td>
                                    <td><code>{{ product.product__product_code }}</code></td>
                                    <td>
                                        {% if product.product__sale_price %}
                                        <span class="text-danger">৳{{ product.product__sale_price }}</span>
                                        <small class="text-muted"><del>৳{{ product.product__base_price }}</del></small>
                                        {% else %}
                                        ৳{{ product.product__base_price }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ product.units_sold }}</td>
                                    <td class="text-success">৳{{ product.total_revenue|floatformat:2 }}</td>
                                    <td class="text-center">{{ product.order_count }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-3">
                                        No sales data available for the selected period
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Status Breakdown -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Order Status</h6>
                </div>
                <div class="card-body">
                    <canvas id="orderStatusChart" height="250"></canvas>
                    <div class="mt-3">
                        {% for status in sales_analytics.status_breakdown %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-capitalize">{{ status.order_status }}</span>
                            <div>
                                <span class="badge badge-primary">{{ status.count }}</span>
                                <small class="text-muted ml-2">৳{{ status.revenue|default:0|floatformat:2 }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'analytics:sales_analytics' %}" class="btn btn-outline-primary btn-block">
                                <i class="fas fa-chart-line mr-2"></i>Sales Analytics
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'analytics:customer_list' %}" class="btn btn-outline-info btn-block">
                                <i class="fas fa-users mr-2"></i>Customer Management
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'analytics:financial_dashboard' %}" class="btn btn-outline-success btn-block">
                                <i class="fas fa-chart-pie mr-2"></i>Financial Reports
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="/admin/inventory/inventory/" class="btn btn-outline-warning btn-block">
                                <i class="fas fa-boxes mr-2"></i>Inventory Management
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Sales Chart Data
const salesData = {{ sales_analytics.daily_sales|safe }};
const dates = salesData.map(item => new Date(item.date).toLocaleDateString());
const revenueData = salesData.map(item => parseFloat(item.revenue || 0));
const ordersData = salesData.map(item => item.orders || 0);

let currentChart = 'revenue';

// Initialize Sales Chart
const salesCtx = document.getElementById('salesChart').getContext('2d');
const salesChart = new Chart(salesCtx, {
    type: 'line',
    data: {
        labels: dates,
        datasets: [{
            label: 'Revenue (৳)',
            data: revenueData,
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            tension: 0.4,
            fill: true,
            yAxisID: 'y'
        }]
    },
    options: {
        responsive: true,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        scales: {
            x: {
                display: true,
                title: {
                    display: true,
                    text: 'Date'
                }
            },
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Revenue (৳)'
                },
                beginAtZero: true
            }
        }
    }
});

// Order Status Chart
const statusCtx = document.getElementById('orderStatusChart').getContext('2d');
const statusData = {
    labels: {{ sales_analytics.status_breakdown|safe|default:"[]" }}.map(item => item.order_status),
    datasets: [{
        data: {{ sales_analytics.status_breakdown|safe|default:"[]" }}.map(item => item.count),
        backgroundColor: [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'
        ],
        hoverOffset: 4
    }]
};

const orderStatusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: statusData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Chart Switching Function
function switchChart(type) {
    currentChart = type;
    
    if (type === 'revenue') {
        salesChart.data.datasets[0] = {
            label: 'Revenue (৳)',
            data: revenueData,
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            tension: 0.4,
            fill: true,
            yAxisID: 'y'
        };
        salesChart.options.scales.y.title.text = 'Revenue (৳)';
    } else {
        salesChart.data.datasets[0] = {
            label: 'Orders',
            data: ordersData,
            borderColor: '#1cc88a',
            backgroundColor: 'rgba(28, 200, 138, 0.1)',
            tension: 0.4,
            fill: true,
            yAxisID: 'y'
        };
        salesChart.options.scales.y.title.text = 'Orders';
    }
    
    salesChart.update();
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Auto-refresh dashboard every 5 minutes
setTimeout(() => {
    window.location.reload();
}, 300000);
</script>
{% endblock %}