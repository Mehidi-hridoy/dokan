{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Dokan{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .positive-change {
        color: #10b981;
    }
    .negative-change {
        color: #ef4444;
    }
    .progress-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        border-radius: 3px;
        transition: width 0.5s ease-in-out;
    }
    .activity-item {
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
    }
    .activity-item:hover {
        border-left-color: #3b82f6;
        background-color: #f8fafc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-6">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Analytics Dashboard</h1>
            <p class="text-gray-600">Overview of your business performance</p>
        </div>
        <div class="flex items-center space-x-4 mt-4 lg:mt-0">
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-600">Period:</span>
                <select id="periodSelect" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </div>
            <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Today's Sales -->
        <div class="stat-card bg-white rounded-xl border p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Today's Sales</p>
                    <p class="text-2xl font-bold text-gray-900">৳{{ quick_stats.today_sales }}</p>
                    <p class="text-sm {% if quick_stats.sales_change >= 0 %}positive-change{% else %}negative-change{% endif %}">
                        <i class="fas fa-arrow-{% if quick_stats.sales_change >= 0 %}up{% else %}down{% endif %} mr-1"></i>
                        {{ quick_stats.sales_change|floatformat:1 }}% from yesterday
                    </p>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Today's Orders -->
        <div class="stat-card bg-white rounded-xl border p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Today's Orders</p>
                    <p class="text-2xl font-bold text-gray-900">{{ quick_stats.today_orders }}</p>
                    <p class="text-sm {% if quick_stats.orders_change >= 0 %}positive-change{% else %}negative-change{% endif %}">
                        <i class="fas fa-arrow-{% if quick_stats.orders_change >= 0 %}up{% else %}down{% endif %} mr-1"></i>
                        {{ quick_stats.orders_change|floatformat:1 }}% from yesterday
                    </p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class="fas fa-shopping-cart text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Pending Orders -->
        <div class="stat-card bg-white rounded-xl border p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Pending Orders</p>
                    <p class="text-2xl font-bold text-gray-900">{{ quick_stats.pending_orders }}</p>
                    <p class="text-sm text-gray-600">Need attention</p>
                </div>
                <div class="bg-yellow-100 p-3 rounded-full">
                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Low Stock -->
        <div class="stat-card bg-white rounded-xl border p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Low Stock Items</p>
                    <p class="text-2xl font-bold text-gray-900">{{ quick_stats.low_stock_products }}</p>
                    <p class="text-sm text-gray-600">Need restocking</p>
                </div>
                <div class="bg-red-100 p-3 rounded-full">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Income & Expenses -->
        <div class="bg-white rounded-xl border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Financial Overview</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-gray-900">Total Income</p>
                        <p class="text-2xl font-bold text-green-600">৳{{ financial_overview.total_income.amount|floatformat:2 }}</p>
                        <p class="text-sm {% if financial_overview.total_income.change >= 0 %}positive-change{% else %}negative-change{% endif %}">
                            {{ financial_overview.total_income.change|floatformat:1 }}% change
                        </p>
                    </div>
                    <i class="fas fa-money-bill-wave text-green-500 text-2xl"></i>
                </div>

                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-gray-900">Total Expenses</p>
                        <p class="text-2xl font-bold text-red-600">৳{{ financial_overview.total_expenses.amount|floatformat:2 }}</p>
                        <p class="text-sm text-gray-600">
                            Operational: ৳{{ financial_overview.total_expenses.breakdown.operational|floatformat:2 }} | 
                            Damages: ৳{{ financial_overview.total_expenses.breakdown.damages|floatformat:2 }}
                        </p>
                    </div>
                    <i class="fas fa-receipt text-red-500 text-2xl"></i>
                </div>

                <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                    <div>
                        <p class="font-medium text-gray-900">Net Balance</p>
                        <p class="text-2xl font-bold text-blue-600">৳{{ financial_overview.net_balance.amount|floatformat:2 }}</p>
                        <p class="text-sm {% if financial_overview.net_balance.change >= 0 %}positive-change{% else %}negative-change{% endif %}">
                            {{ financial_overview.net_balance.change|floatformat:1 }}% change
                        </p>
                    </div>
                    <i class="fas fa-chart-line text-blue-500 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Customer Statistics -->
        <div class="bg-white rounded-xl border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Customer Insights</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-2xl font-bold text-blue-600">{{ customer_stats.total_customers }}</p>
                        <p class="text-sm text-gray-600">Total Customers</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <p class="text-2xl font-bold text-green-600">{{ customer_stats.new_customers }}</p>
                        <p class="text-sm text-gray-600">New Customers</p>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <p class="text-2xl font-bold text-purple-600">{{ customer_stats.vip_customers }}</p>
                        <p class="text-sm text-gray-600">VIP Customers</p>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <p class="text-2xl font-bold text-red-600">{{ customer_stats.fraud_customers }}</p>
                        <p class="text-sm text-gray-600">Fraud Cases</p>
                    </div>
                </div>
                
                <!-- Customer Type Distribution -->
                <div class="mt-4">
                    <p class="font-medium text-gray-700 mb-2">Customer Distribution</p>
                    <div class="space-y-2">
                        {% with total=customer_stats.total_customers %}
                        <div class="flex justify-between text-sm">
                            <span>New Customers</span>
                            <span>{{ customer_stats.new_customers }}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill bg-blue-500" 
                                 style="width: {% widthratio customer_stats.new_customers total 100 %}%"></div>
                        </div>
                        
                        <div class="flex justify-between text-sm">
                            <span>Regular Customers</span>
                            <span>{{ customer_stats.regular_customers }}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill bg-green-500" 
                                 style="width: {% widthratio customer_stats.regular_customers total 100 %}%"></div>
                        </div>
                        
                        <div class="flex justify-between text-sm">
                            <span>VIP Customers</span>
                            <span>{{ customer_stats.vip_customers }}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill bg-purple-500" 
                                 style="width: {% widthratio customer_stats.vip_customers total 100 %}%"></div>
                        </div>
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales & Products -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Sales Performance -->
        <div class="bg-white rounded-xl border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Sales Performance</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-xl font-bold text-gray-900">{{ sales_analytics.orders.total_orders|default:0 }}</p>
                        <p class="text-sm text-gray-600">Total Orders</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-xl font-bold text-gray-900">{{ sales_analytics.orders.completed_orders|default:0 }}</p>
                        <p class="text-sm text-gray-600">Completed</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-xl font-bold text-gray-900">৳{{ sales_analytics.orders.avg_order_value|default:0|floatformat:2 }}</p>
                        <p class="text-sm text-gray-600">Avg Order Value</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-xl font-bold text-gray-900">৳{{ sales_analytics.orders.total_revenue|default:0|floatformat:2 }}</p>
                        <p class="text-sm text-gray-600">Total Revenue</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Products -->
        <div class="bg-white rounded-xl border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Performing Products</h3>
            <div class="space-y-3">
                {% for product in top_products %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">{{ product.product__products_name }}</p>
                        <p class="text-sm text-gray-600">Code: {{ product.product__product_code }}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">৳{{ product.total_revenue|floatformat:2 }}</p>
                        <p class="text-sm text-gray-600">{{ product.total_sold }} sold</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-4">No sales data available</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Recent Activities & Expense Breakdown -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Recent Activities -->
        <div class="bg-white rounded-xl border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Activities</h3>
            <div class="space-y-3">
                {% for activity in recent_activities %}
                <div class="activity-item p-4 border-l-4 
                    {% if activity.color == 'blue' %}border-blue-500
                    {% elif activity.color == 'red' %}border-red-500
                    {% else %}border-orange-500{% endif %}">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-3">
                            <div class="{% if activity.color == 'blue' %}bg-blue-100
                                      {% elif activity.color == 'red' %}bg-red-100
                                      {% else %}bg-orange-100{% endif %} p-2 rounded-full mt-1">
                                <i class="{{ activity.icon }} 
                                    {% if activity.color == 'blue' %}text-blue-600
                                    {% elif activity.color == 'red' %}text-red-600
                                    {% else %}text-orange-600{% endif %}"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">{{ activity.title }}</p>
                                <p class="text-sm text-gray-600">{{ activity.description }}</p>
                                <p class="text-xs text-gray-500 mt-1">{{ activity.timestamp|timesince }} ago</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold {% if activity.amount >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if activity.amount >= 0 %}৳{% else %}-৳{% endif %}{{ activity.amount|abs|floatformat:2 }}
                            </p>
                            <span class="inline-block px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded-full">
                                {{ activity.status }}
                            </span>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-4">No recent activities</p>
                {% endfor %}
            </div>
        </div>

        <!-- Expense Breakdown -->
        <div class="bg-white rounded-xl border p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Expense Breakdown</h3>
            <div class="space-y-4">
                {% for expense in expense_analytics.expenses_by_category %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 rounded-full" style="background-color: {{ expense.category__color|default:'#3498db' }}"></div>
                        <span class="font-medium text-gray-900">{{ expense.category__name }}</span>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-red-600">৳{{ expense.total|floatformat:2 }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-4">No expense data available</p>
                {% endfor %}
                
                <!-- Damage Summary -->
                <div class="mt-6 p-4 bg-red-50 rounded-lg">
                    <h4 class="font-semibold text-red-900 mb-2">Damage Reports</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-red-700">Total Cost</p>
                            <p class="font-semibold text-red-900">৳{{ expense_analytics.damage_analytics.total_damages|default:0|floatformat:2 }}</p>
                        </div>
                        <div>
                            <p class="text-red-700">Units Damaged</p>
                            <p class="font-semibold text-red-900">{{ expense_analytics.damage_analytics.total_units|default:0 }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const periodSelect = document.getElementById('periodSelect');
        const refreshBtn = document.getElementById('refreshBtn');
        
        refreshBtn.addEventListener('click', function() {
            const period = periodSelect.value;
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            
            fetch(`/analytics/dashboard-data/?period=${period}`)
                .then(response => response.json())
                .then(data => {
                    location.reload(); // Simple refresh for demo
                })
                .catch(error => {
                    console.error('Error refreshing dashboard:', error);
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Refresh';
                    alert('Error refreshing dashboard data');
                });
        });
    });
</script>
{% endblock %}