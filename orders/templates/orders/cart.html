{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - Dokan{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Shopping Cart</h1>

    {% if cart_items %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart Items -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-md border border-gray-100">
                <div class="border-b border-gray-200 px-6 py-4">
                    <h2 class="text-xl font-semibold text-gray-800">Your Items (<span id="cart-count">{{ cart_count }}</span>)</h2>
                </div>

                <div class="divide-y divide-gray-200" id="cart-items-container">
                    {% for item in cart_items %}
                    <div class="p-6 cart-item-row" data-cart-key="{{ item.cart_key }}">
                        <div class="flex items-center space-x-4">
                            <!-- Product Image -->
                            <div class="flex-shrink-0">
                                <a href="{% url 'products:product_detail' item.product.slug %}">
                                    {% if item.product.products_image %}
                                    <img src="{{ item.product.products_image.url }}" alt="{{ item.product.products_name }}" class="w-20 h-20 object-cover rounded-lg">
                                    {% else %}
                                    <div class="w-20 h-20 bg-gray-200 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-image text-gray-400"></i>
                                    </div>
                                    {% endif %}
                                </a>
                            </div>

                            <!-- Product Details -->
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">
                                    <a href="{% url 'products:product_detail' item.product.slug %}" class="hover:text-blue-600">
                                        {{ item.product.products_name }}
                                    </a>
                                </h3>
                                <div class="text-sm text-gray-600 space-y-1">
                                    {% if item.color %}<div><strong>Color:</strong> {{ item.color }}</div>{% endif %}
                                    {% if item.size %}<div><strong>Size:</strong> {{ item.size }}</div>{% endif %}
                                    {% if item.weight %}<div><strong>Weight:</strong> {{ item.weight }}</div>{% endif %}
                                </div>
                                <div class="flex items-center justify-between mt-2">
                              <span class="text-lg font-bold text-gray-900">Unit Price $<span class="unit-price">{{ item.unit_price }}</span>
                                </span>
                                </div>
                            </div>

                            <!-- Quantity Controls & Remove -->
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center border border-gray-300 rounded-lg">
                                    <button type="button" onclick="changeQuantity('{{ item.cart_key }}', -1)" class="px-3 py-1 text-gray-600 hover:text-gray-800">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span id="quantity-{{ item.cart_key }}" class="px-3 py-1 text-gray-800 font-semibold">{{ item.quantity }}</span>
                                    <button type="button" onclick="changeQuantity('{{ item.cart_key }}', 1)" class="px-3 py-1 text-gray-600 hover:text-gray-800">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <button onclick="removeItem('{{ item.cart_key }}')" class="text-red-600 hover:text-red-800 p-2 transition duration-200">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
                            <span class="text-gray-600">Item Total:</span>
                            $<span class="item-subtotal">{{ item.subtotal }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-md border border-gray-100 sticky top-24">
                <div class="p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Order Summary</h2>
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-gray-600">
                            <span>Subtotal (<span id="summary-cart-count">{{ cart_count }}</span> items)</span>
                            $<span id="summary-total">{{ total_price }}</span>
                        </div>
                        <div class="flex justify-between text-gray-600">
                            <span>Shipping</span><span class="text-green-600">Free</span>
                        </div>
                        <div class="flex justify-between text-gray-600">
                            <span>Tax</span><span>Calculated at checkout</span>
                        </div>
                        <div class="border-t border-gray-200 pt-3">
                            <div class="flex justify-between text-lg font-bold text-gray-900">
                                <span>Total</span>
                                $<span id="summary-total-final">{{ total_price }}</span>
                            </div>
                        </div>
                    </div>

                    <a href="{% url 'orders:checkout' %}" class="w-full bg-blue-600 text-white py-4 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center mb-4">
                        <i class="fas fa-lock mr-3"></i> Proceed to Checkout
                    </a>
                    <a href="{% url 'products:product_list' %}" class="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 text-center block">
                        Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center py-16">
        <i class="fas fa-shopping-cart text-6xl text-gray-400 mb-6"></i>
        <h2 class="text-2xl font-bold text-gray-600 mb-4">Your cart is empty</h2>
        <p class="text-gray-500 mb-8">Looks like you haven't added any items to your cart yet.</p>
        <a href="{% url 'products:product_list' %}" class="bg-blue-600 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-200 inline-block">Start Shopping</a>
    </div>
    {% endif %}
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.cart-item-row').forEach(row => {
        const cartKey = row.dataset.cartKey;

        row.querySelector('.fa-plus')?.closest('button')?.addEventListener('click', () => changeQuantity(cartKey, 1));
        row.querySelector('.fa-minus')?.closest('button')?.addEventListener('click', () => changeQuantity(cartKey, -1));
    });
});

function changeQuantity(cartKey, delta) {
    const qtySpan = document.getElementById(`quantity-${cartKey}`);
    let quantity = parseInt(qtySpan.textContent) + delta;
    if (quantity < 1) quantity = 1;

    // Update frontend instantly
    updateFrontendTotals(cartKey, quantity);

    // Sync with server
    updateCartItem(cartKey, quantity);
}

function updateFrontendTotals(cartKey, quantity) {
    const row = document.querySelector(`.cart-item-row[data-cart-key="${cartKey}"]`);
    const unitPrice = parseFloat(row.querySelector('.unit-price').textContent);
    const itemSubtotal = unitPrice * quantity;

    // Update quantity and item subtotal
    row.querySelector(`#quantity-${cartKey}`).textContent = quantity;
    row.querySelector('.item-subtotal').textContent = itemSubtotal.toFixed(2);

    // Recalculate order summary
    let total = 0;
    let totalCount = 0;
    document.querySelectorAll('.cart-item-row').forEach(r => {
        const qty = parseInt(r.querySelector(`[id^="quantity-"]`).textContent);
        const price = parseFloat(r.querySelector('.unit-price').textContent);
        total += qty * price;
        totalCount += qty;
    });

    document.getElementById('summary-total').textContent = total.toFixed(2);
    document.getElementById('summary-total-final').textContent = total.toFixed(2);
    document.getElementById('cart-count').textContent = totalCount;
    document.getElementById('summary-cart-count').textContent = totalCount;
}

function removeItem(cartKey) {
    const row = document.querySelector(`.cart-item-row[data-cart-key="${cartKey}"]`);
    if (row) row.remove();

    updateCartItem(cartKey, 0);
}
  
function updateCartItem(cartKey, quantity) {
    const formData = new FormData();
    formData.append('cart_key', cartKey);
    formData.append('quantity', quantity);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch("{% url 'orders:update_cart' %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) return;
        // Server sync complete, nothing else to do because frontend is already updated
        if (data.cart_count === 0) location.reload(); // optional: show empty cart
    })
    .catch(err => console.error('Cart update failed', err));
}
</script>


{% endblock %}
